import pytest
from littlefs import lfs
from littlefs.errors import LittleFSException

# A very small filesystem with block_size=128, block_count=4
FORMATED_FS = bytearray(
    b'\x01\x00\x00\x00\xf0\x0f\xff\xf7littlefs/\xe0\x00\x10'
    b'\x00\x00\x02\x00\x80\x00\x00\x00\x04\x00\x00\x00\xff\x00\x00\x00'
    b'\xff\xff\xff\x7f\xfe\x03\x00\x00p\x1f\xfcH0\xcf\x7f\xfc'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x02\x00\x00\x00'
    b'\xf0\x0f\xff\xf7littlefs/\xe0\x00\x10\x00\x00\x02\x00'
    b'\x80\x00\x00\x00\x04\x00\x00\x00\xff\x00\x00\x00\xff\xff\xff\x7f'
    b'\xfe\x03\x00\x00p\x1f\xfcHT\xfa\xad\xba\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff'
)


@pytest.fixture(scope='function')
def fs():
    fs = lfs.LFSFilesystem()
    yield fs

@pytest.fixture(scope='function')
def cfg():
    cfg = lfs.LFSConfig(block_size=128, block_count=4)
    yield cfg

@pytest.fixture(scope='function')
def formated_fs(fs, cfg):
    lfs.format(fs, cfg)
    yield fs

@pytest.fixture(scope='function')
def mounted_fs(formated_fs, cfg):
    lfs.mount(formated_fs, cfg)
    yield formated_fs

def test_mount_unformatted(fs, cfg):
    """Mounting a unformated filesystem should lead to an error -84
    which means the filesystem is corrupted
    """
    with pytest.raises(LittleFSException) as excinfo:
        lfs.mount(fs, cfg)

    assert excinfo.value.code == -84


def test_mount_formatted(fs, cfg):
    """Mounting a formated filesystem should work as expected"""
    lfs.format(fs, cfg)
    assert lfs.mount(fs, cfg) == 0


def test_format(fs, cfg):
    """Test if filesystem formatting works as expected"""
    assert lfs.format(fs, cfg) == 0


def test_unmount(mounted_fs):
    """Test if the filesystem can be unmounted"""
    assert lfs.unmount(mounted_fs) == 0


def test_stat_root_directory(mounted_fs):
    """Test if stat works"""
    stat = lfs.stat(mounted_fs, '/')
    assert stat.type == 2, 'Expected a directory type'
    assert stat.name == '/'


def test_stat_file(mounted_fs):
    fh = lfs.file_open(mounted_fs, 'test.txt', 'w')
    lfs.file_write(mounted_fs, fh, b'0123456789')
    lfs.file_close(mounted_fs, fh)

    stat = lfs.stat(mounted_fs, 'test.txt')
  
    assert stat.size == 10
    assert stat.type == 1
    assert stat.name == 'test.txt'
    